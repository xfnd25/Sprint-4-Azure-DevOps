# Define o gatilho de CI (Integração Contínua)
# Cumpre o Requisito 7.II: Disparar na branch 'master'
trigger:
- master

# Define o agente de build para usar seu PC
pool:
  name: 'meu-pc-windows'

# Vincula o grupo de variáveis que criamos.
# Cumpre o Requisito 7.IV: Usar variáveis protegidas.
variables:
- group: Segredos-Producao

# --- Variáveis Padrão ---
- name: AZURE_SUBSCRIPTION
  value: 'Conexao-Azure-Sprint4'
- name: ACR_CONNECTION
  value: 'Conexao-ACR-Sprint4'
- name: ACR_NAME
  value: 'acrmotorm555317'
- name: WEBAPP_NAME
  value: 'app-motolocation-rm555317'
- name: IMAGE_NAME
  value: 'motolocation'
- name: IMAGE_TAG
  value: '$(Build.BuildId)'

# --- Estágios do Pipeline ---
stages:

# ESTÁGIO 1: CI (Continuous Integration) - JÁ ESTÁ FUNCIONANDO (VERDE ✅)
- stage: Build
  displayName: 'CI: Build, Test & Push Image'
  jobs:
  - job: BuildAndTest
    displayName: 'Build, Test and Push to ACR'
    steps:

    # Passo 1: Rodar os testes unitários (Req 7.V)
    - task: Maven@3
      displayName: '1. Run Maven Tests (CI)'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'test'
        publishJUnitTestResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        javaHomeOption: 'Path'
        jdkDirectory: '$(JAVA_HOME)'

    # Passo 2: Construir e Enviar a Imagem Docker (Req 7.IV e 7.VII)
    - task: Docker@2
      displayName: '2. Build and Push Image to ACR'
      inputs:
        command: 'buildAndPush'
        containerRegistry: $(ACR_CONNECTION)
        repository: $(IMAGE_NAME)
        dockerfile: 'Dockerfile'
        tags: |
          $(IMAGE_TAG)
          latest

# ESTÁGIO 2: CD (Continuous Deployment)
- stage: Deploy
  displayName: 'CD: Deploy to Azure Web App'
  dependsOn: Build # Req 7.III: Só roda se o 'Build' for bem-sucedido
  condition: succeeded()
  jobs:
  - job: DeployApp
    displayName: 'Deploy to App Service'
    steps:

    # --- CORREÇÃO AQUI (PASSO 1 DO DEPLOY) ---
    # Removemos o bloco 'env:' (inútil para este plugin)
    # E adicionamos o bloco 'options:', que passa as variáveis
    # diretamente para o comando 'mvn' usando -D.
    # O plugin do Flyway lê essas propriedades.
    - task: Maven@3
      displayName: '1. Run Database Migrations (Flyway)'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'flyway:migrate'
        javaHomeOption: 'Path'
        jdkDirectory: '$(JAVA_HOME)'
        options: >-
          -Dflyway.url=$(SPRING_DATASOURCE_URL)
          -Dflyway.user=$(SPRING_DATASOURCE_USERNAME)
          -Dflyway.password=$(SPRING_DATASOURCE_PASSWORD)

    # Passo 2: Implantar (Deploy) no App Service (Req 7.VI e 7.VII)
    - task: AzureWebAppContainer@1
      displayName: '2. Deploy Image to App Service'
      inputs:
        azureSubscription: $(AZURE_SUBSCRIPTION)
        appName: $(WEBAPP_NAME)
        imageName: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)'
            
        # Define as variáveis de ambiente para a APLICAÇÃO (Spring Boot)
        # ESTA PARTE ESTAVA CORRETA, pois o Spring Boot LÊ variáveis de ambiente.
        appSettings: |
          WEBSITES_PORT=8080
          SPRING_DATASOURCE_URL=$(SPRING_DATASOURCE_URL)
          SPRING_DATASOURCE_USERNAME=$(SPRING_DATASOURCE_USERNAME)
          SPRING_DATASOURCE_PASSWORD=$(SPRING_DATASOURCE_PASSWORD)
          MOTOLOCATION_API_KEY=$(MOTOLOCATION_API_KEY)